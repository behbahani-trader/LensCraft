{% extends "base.html" %}

{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
            <h1 class="text-4xl font-bold mb-2">ğŸ“„ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´ #{{ order.id }}</h1>
            <p class="text-base-content/70">Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø³ÙØ§Ø±Ø´</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('orders.edit', id=order.id) }}" class="btn btn-outline btn-primary">
                <span class="ml-2">âœï¸</span>
                ÙˆÛŒØ±Ø§ÛŒØ´
            </a>
            <button class="btn btn-outline btn-error" onclick="document.getElementById('delete_modal').showModal()">
                <span class="ml-2">ğŸ—‘ï¸</span>
                Ø­Ø°Ù
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Ø³ØªÙˆÙ† Ø§ØµÙ„ÛŒ -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ Ø³ÙØ§Ø±Ø´</h2>
                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div class="flex flex-col">
                            <dt class="text-sm font-medium text-base-content/70">Ù…Ø´ØªØ±ÛŒ</dt>
                            <dd class="text-lg font-semibold">
                                {% if order.customer %}
                                    <a href="{{ url_for('customers.show', id=order.customer.id) }}" class="link link-hover link-primary">{{ order.customer.full_name }}</a>
                                {% else %}
                                    <span class="text-error">Ù…Ø´ØªØ±ÛŒ Ø­Ø°Ù Ø´Ø¯Ù‡</span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="flex flex-col">
                            <dt class="text-sm font-medium text-base-content/70">ØªÙ„ÙÙ† Ù…Ø´ØªØ±ÛŒ</dt>
                            <dd class="text-lg font-semibold">
                                {% if order.customer %}
                                    {{ order.customer.phone }}
                                {% else %}
                                    -
                                {% endif %}
                            </dd>
                        </div>
                        <div class="flex flex-col">
                            <dt class="text-sm font-medium text-base-content/70">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</dt>
                            <dd class="text-lg font-semibold">
                                {% if order.jalali_created_at %}
                                    {{ order.jalali_created_at }}
                                {% else %}
                                    Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
                                {% endif %}
                            </dd>
                        </div>
                        <div class="flex flex-col">
                            <dt class="text-sm font-medium text-base-content/70">ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</dt>
                            <dd class="text-lg font-semibold">
                                {% if order.jalali_delivery_date %}
                                    {{ order.jalali_delivery_date }}
                                {% else %}
                                    Ù†Ø§Ù…Ø´Ø®Øµ
                                {% endif %}
                            </dd>
                        </div>
                        <div class="flex flex-col">
                            <dt class="text-sm font-medium text-base-content/70">ÙˆØ¶Ø¹ÛŒØª</dt>
                            <dd><span class="badge badge-lg font-bold badge-{{ order.status_color }}">{{ order.status_display }}</span></dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- Ø¹Ø¯Ø³ÛŒâ€ŒÙ‡Ø§ -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">Ø¹Ø¯Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´</h2>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>Ù†ÙˆØ¹ Ø¹Ø¯Ø³ÛŒ</th>
                                    <th>Ù†ÙˆØ¹ ØªØ±Ø§Ø´</th>
                                    <th class="text-center">ØªØ¹Ø¯Ø§Ø¯</th>
                                    <th class="text-right">Ù‚ÛŒÙ…Øª ÙÛŒ</th>
                                    <th class="text-right">Ù‚ÛŒÙ…Øª Ú©Ù„</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lens in order.lenses %}
                                <tr>
                                    <td>{% if lens.lens_type %}{{ lens.lens_type.name }}{% endif %}</td>
                                    <td>{% if lens.lens_cut_type %}{{ lens.lens_cut_type.name }}{% endif %}</td>
                                    <td class="text-center">{{ lens.quantity }}</td>
                                    <td class="text-right font-mono">
                                        {% if lens.unit_price is not none %}
                                            {{ "{:,.0f}".format(lens.unit_price) }}
                                        {% endif %}
                                    </td>
                                    <td class="text-right font-mono font-bold">
                                        {% if lens.price is not none %}
                                            {{ "{:,.0f}".format(lens.price) }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {% if order.notes %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">ØªÙˆØ¶ÛŒØ­Ø§Øª</h2>
                    <p class="whitespace-pre-wrap">{{ order.notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Ø³ØªÙˆÙ† Ú©Ù†Ø§Ø±ÛŒ -->
        <div class="lg:col-span-1 flex flex-col gap-6">
            <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ</h2>
                    <dl class="space-y-4">
                        <div class="flex justify-between items-baseline">
                            <dt class="text-base-content/70">Ø¬Ù…Ø¹ Ú©Ù„ Ø¹Ø¯Ø³ÛŒâ€ŒÙ‡Ø§</dt>
                            <dd class="text-lg font-bold font-mono">{% if order.lenses_total is not none %}{{ "{:,.0f}".format(order.lenses_total) }}{% else %}0{% endif %} ØªÙˆÙ…Ø§Ù†</dd>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <dt class="text-base-content/70">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ</dt>
                            <dd class="text-lg font-bold font-mono">{% if order.expenses_total is not none %}{{ "{:,.0f}".format(order.expenses_total) }}{% else %}0{% endif %} ØªÙˆÙ…Ø§Ù†</dd>
                        </div>
                        <div class="divider my-0"></div>
                        <div class="flex justify-between items-baseline text-xl">
                            <dt class="font-bold">Ù…Ø¨Ù„Øº Ú©Ù„ Ø³ÙØ§Ø±Ø´</dt>
                            <dd class="font-extrabold font-mono text-primary">{% if order.total_amount is not none %}{{ "{:,.0f}".format(order.total_amount) }}{% else %}0{% endif %} ØªÙˆÙ…Ø§Ù†</dd>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <dt class="text-base-content/70">Ù¾ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</dt>
                            <dd class="font-bold font-mono text-success">{% if order.payment is not none %}{{ "{:,.0f}".format(order.payment) }}{% else %}0{% endif %} ØªÙˆÙ…Ø§Ù†</dd>
                        </div>
                        <div class="divider my-0"></div>
                        <div class="flex justify-between items-baseline text-xl">
                            <dt class="font-bold">Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</dt>
                            <dd class="font-extrabold font-mono text-error">{% if order.remaining_amount is not none %}{{ "{:,.0f}".format(order.remaining_amount) }}{% else %}0{% endif %} ØªÙˆÙ…Ø§Ù†</dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª</h2>
                    <div class="grid grid-cols-2 gap-2">
                        {% set statuses = {'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±', 'in_progress': 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…', 'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡', 'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'} %}
                        {% for status_key, status_value in statuses.items() %}
                            {% if order.status != status_key %}
                            <form method="POST" action="{{ url_for('orders.update_status', id=order.id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="status" value="{{ status_key }}">
                                <button type="submit" class="btn btn-outline w-full">{{ status_value }}</button>
                            </form>
                            {% else %}
                            <button class="btn btn-active w-full" disabled>{{ status_value }}</button>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<dialog id="delete_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Ø­Ø°Ù Ø³ÙØ§Ø±Ø´</h3>
        <p class="py-4">Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø³ÙØ§Ø±Ø´ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.</p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Ø§Ù†ØµØ±Ø§Ù</button>
            </form>
            <form method="POST" action="{{ url_for('orders.delete', id=order.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-error">Ø­Ø°Ù</button>
            </form>
        </div>
    </div>
</dialog>
{% endblock %}