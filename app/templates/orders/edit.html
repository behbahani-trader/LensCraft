{% extends "base.html" %}

{% block title %}ÙˆÛŒØ±Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{{ url_for('orders.index') }}" class="flex items-center gap-2">
        <span>ğŸ“‹</span>
        <span>Ø³ÙØ§Ø±Ø´Ø§Øª</span>
    </a>
</li>
<li class="breadcrumb-item">
    <a href="{{ url_for('orders.show', id=order.id) }}" class="flex items-center gap-2">
        <span>#{{ order.id }}</span>
    </a>
</li>
<li class="breadcrumb-item">
    <span class="flex items-center gap-2 text-primary">
        <span>âœï¸</span>
        <span>ÙˆÛŒØ±Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´</span>
    </span>
</li>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
            <h1 class="text-4xl font-bold mb-2">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´ #{{ order.id }}</h1>
            <p class="text-base-content/70">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´ Ù…Ø´ØªØ±ÛŒ</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('orders.show', id=order.id) }}" class="btn btn-outline">
                <span class="ml-2">ğŸ”™</span>
                Ø¨Ø§Ø²Ú¯Ø´Øª
            </a>
        </div>
    </div>

    <form method="POST" id="orderForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ Ø³ÙØ§Ø±Ø´ -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-header bg-primary text-primary-content p-4 rounded-t-2xl">
                <h2 class="card-title">ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´</h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Ù…Ø´ØªØ±ÛŒ -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ</span>
                            <span class="label-text-alt text-error">*</span>
                        </label>
                        <div class="flex gap-2">
                            <select name="customer_id" id="customer-select" class="select select-bordered flex-1" required>
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}" data-phone="{{ customer.phone or '' }}"
                                        {% if customer.id == order.customer_id %}selected{% endif %}>
                                    {{ customer.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <a href="{{ url_for('customers.new') }}" class="btn btn-outline btn-square" title="Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯">
                                <span>ğŸ‘¤â•</span>
                            </a>
                        </div>
                        <div class="label">
                            <span class="label-text-alt" id="customer-info"></span>
                        </div>
                    </div>

                    <!-- ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">ğŸ“… ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</span>
                            <span class="label-text-alt text-error">*</span>
                        </label>
                        <input type="date" name="created_at" class="input input-bordered" required 
                               value="{{ order.created_at.strftime('%Y-%m-%d') }}" />
                    </div>

                    <!-- Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´</span>
                        </label>
                        <input type="text" class="input input-bordered bg-base-200 font-mono text-lg" value="{{ order.id }}" readonly />
                    </div>

                    <!-- ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„ -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">ğŸšš ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</span>
                        </label>
                        <input type="date" name="delivery_date" class="input input-bordered"
                               value="{{ order.delivery_date.strftime('%Y-%m-%d') if order.delivery_date else '' }}" />
                    </div>

                    <!-- ÙˆØ¶Ø¹ÛŒØª -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">ğŸ“Š ÙˆØ¶Ø¹ÛŒØª</span>
                            <span class="label-text-alt text-error">*</span>
                        </label>
                        <select name="status" class="select select-bordered" required>
                            <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
                            <option value="in_progress" {% if order.status == 'in_progress' %}selected{% endif %}>ğŸ› ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                            <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                            <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>âŒ Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ø¹Ø¯Ø³ÛŒâ€ŒÙ‡Ø§ -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-header bg-secondary text-secondary-content p-4 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h2 class="card-title">ğŸ‘“ Ø¹Ø¯Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´</h2>
                    <button type="button" onclick="addLensRow()" class="btn btn-primary btn-sm">
                        <span class="ml-1">â•</span>
                        Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Ù†ÙˆØ¹ Ø¹Ø¯Ø³ÛŒ</th>
                                <th>Ù†ÙˆØ¹ ØªØ±Ø§Ø´</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯</th>
                                <th>Ù‚ÛŒÙ…Øª ÙÛŒ</th>
                                <th>Ù‚ÛŒÙ…Øª Ú©Ù„</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="lenses-container">
                            {% for lens in order.lenses %}
                            <tr class="lens-row">
                                <td>
                                    <select name="lens_type_id[]" class="select select-bordered w-full lens-type" required>
                                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¹Ø¯Ø³ÛŒ</option>
                                        {% for lens_type in lens_types %}
                                        <option value="{{ lens_type.id }}" data-price="{{ lens_type.default_price }}"
                                                {% if lens_type.id == lens.lens_type_id %}selected{% endif %}>
                                            {{ lens_type.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <select name="lens_cut_type_id[]" class="select select-bordered w-full lens-cut-type" required>
                                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ØªØ±Ø§Ø´</option>
                                        {% for cut_type in lens_cut_types %}
                                        <option value="{{ cut_type.id }}" data-price="{{ cut_type.default_price }}"
                                                {% if cut_type.id == lens.lens_cut_type_id %}selected{% endif %}>
                                            {{ cut_type.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="number" name="lens_quantity[]" value="{{ lens.quantity }}" min="1" class="input input-bordered w-full lens-quantity" required>
                                </td>
                                <td>
                                    <input type="number" name="lens_unit_price[]" value="{{ lens.unit_price }}" class="input input-bordered w-full lens-unit-price" placeholder="Ù‚ÛŒÙ…Øª ÙÛŒ (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)" title="Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ† Ù‚ÛŒÙ…Øª Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯">
                                </td>
                                <td>
                                    <input type="number" name="lens_price[]" value="{{ lens.price }}" class="input input-bordered w-full lens-price bg-base-200" readonly>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-error btn-sm" onclick="removeRow(this)">
                                        <span>ğŸ—‘ï¸</span>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <!-- Ø±Ø¯ÛŒÙ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ú¯Ø± Ø¹Ø¯Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ -->
                            <tr class="lens-row">
                                <td>
                                    <select name="lens_type_id[]" class="select select-bordered w-full lens-type" required>
                                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¹Ø¯Ø³ÛŒ</option>
                                        {% for lens_type in lens_types %}
                                        <option value="{{ lens_type.id }}" data-price="{{ lens_type.default_price }}">{{ lens_type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <select name="lens_cut_type_id[]" class="select select-bordered w-full lens-cut-type" required>
                                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ØªØ±Ø§Ø´</option>
                                        {% for cut_type in lens_cut_types %}
                                        <option value="{{ cut_type.id }}" data-price="{{ cut_type.default_price }}">{{ cut_type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="number" name="lens_quantity[]" value="1" min="1" class="input input-bordered w-full lens-quantity" required>
                                </td>
                                <td>
                                    <input type="number" name="lens_unit_price[]" class="input input-bordered w-full lens-unit-price" placeholder="Ù‚ÛŒÙ…Øª ÙÛŒ (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)" title="Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ† Ù‚ÛŒÙ…Øª Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯">
                                </td>
                                <td>
                                    <input type="number" name="lens_price[]" class="input input-bordered w-full lens-price bg-base-200" readonly>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-error btn-sm" onclick="removeRow(this)">
                                        <span>ğŸ—‘ï¸</span>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Ø®Ù„Ø§ØµÙ‡ -->
                <div class="flex justify-between items-center mt-4 p-4 bg-base-200 rounded-lg">
                    <div class="text-lg font-bold">
                        Ø¬Ù…Ø¹ Ú©Ù„: <span id="total-amount-display">0</span> ØªÙˆÙ…Ø§Ù†
                    </div>
                    <div class="text-sm">
                        ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¹Ø¯Ø³ÛŒ: <span id="total-quantity-display">0</span> Ø¹Ø¯Ø¯
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-header bg-success text-success-content p-4 rounded-t-2xl">
                <h2 class="card-title">ğŸ’° Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ</h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ù…Ø¨Ù„Øº Ú©Ù„ -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">ğŸ’µ Ù…Ø¨Ù„Øº Ú©Ù„ Ø³ÙØ§Ø±Ø´</span>
                        </label>
                        <div class="relative">
                            <input type="number" name="total_amount" id="total_amount" 
                                   class="input input-bordered input-lg bg-base-200 font-bold text-xl" readonly />
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-base-content/50">
                                ØªÙˆÙ…Ø§Ù†
                            </span>
                        </div>
                    </div>

                    <!-- Ù¾ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">ğŸ’³ Ù¾ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</span>
                        </label>
                        <div class="relative">
                            <input type="number" name="payment" id="payment" class="input input-bordered" 
                                   value="{{ order.payment or 0 }}" min="0" placeholder="Ù…Ø¨Ù„Øº Ù¾ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª" />
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-base-content/50">
                                ØªÙˆÙ…Ø§Ù†
                            </span>
                        </div>
                        <div class="label">
                            <span class="label-text-alt">Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡: <span id="remaining-amount">0</span> ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ØªÙˆØ¶ÛŒØ­Ø§Øª -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-header bg-info text-info-content p-4 rounded-t-2xl">
                <h2 class="card-title">ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª</h2>
            </div>
            <div class="card-body">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">ğŸ“‹ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø³ÙØ§Ø±Ø´</span>
                    </label>
                    <textarea name="notes" class="textarea textarea-bordered h-32" 
                              placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒØŒ Ù†Ú©Ø§Øª ÙˆÛŒÚ˜Ù‡ØŒ ÛŒØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ù…Ø´ØªØ±ÛŒ...">{{ order.notes or '' }}</textarea>
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ (Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡) -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-header bg-error text-error-content p-4 rounded-t-2xl">
                <h2 class="card-title">ğŸ’¸ Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø¶Ø§ÙÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</h2>
            </div>
            <div class="card-body">
                <div id="expenses-list">
                    {% for expense in order.expenses %}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 expense-row mt-2">
                        <div><input name="expense_title[]" class="input input-bordered w-full" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù‡Ø²ÛŒÙ†Ù‡" value="{{ expense.title }}"></div>
                        <div><input name="expense_amount[]" class="input input-bordered w-full" placeholder="Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)" min="1" type="number" value="{{ expense.amount }}"></div>
                        <div class="flex gap-2">
                            <input name="expense_description[]" class="input input-bordered w-full" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" value="{{ expense.description }}">
                            <button type="button" class="btn btn-error btn-xs" onclick="this.closest('.expense-row').remove()">Ø­Ø°Ù</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-4">
                    <button type="button" class="btn btn-outline btn-sm" onclick="addExpenseRow()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯</button>
                </div>
            </div>
        </div>
        
        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <div class="text-sm text-base-content/70">
                        <span>âš ï¸ Ù„Ø·ÙØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ø² Ø«Ø¨ØªØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯</span>
                    </div>
                    <div class="flex gap-3">
                        <a href="{{ url_for('orders.show', id=order.id) }}" class="btn btn-outline">
                            <span class="ml-2">âŒ</span>
                            Ø§Ù†ØµØ±Ø§Ù
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <span class="ml-2">ğŸ’¾</span>
                            Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÙØ§Ø±Ø´
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- Ù¾Ø§ÛŒØ§Ù† ÙØ±Ù… Ø³ÙØ§Ø±Ø´ -->
</div>
{% endblock %}

{% block extra_js %}
<script>
function addExpenseRow() {
    const row = document.createElement('div');
    row.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 expense-row mt-2';
    row.innerHTML = `
        <div><input name="expense_title[]" class="input input-bordered w-full" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù‡Ø²ÛŒÙ†Ù‡" /></div>
        <div><input name="expense_amount[]" class="input input-bordered w-full" placeholder="Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)" min="1" type="number" /></div>
        <div class="flex gap-2"><input name="expense_description[]" class="input input-bordered w-full" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" />
        <button type="button" class="btn btn-error btn-xs" onclick="this.closest('.expense-row').remove()">Ø­Ø°Ù</button></div>
    `;
    document.getElementById('expenses-list').appendChild(row);
}

// ØªØ§Ø¨Ø¹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯
function addLensRow() {
    const container = document.getElementById('lenses-container');
    const newRow = document.createElement('tr');
    newRow.className = 'lens-row';

    newRow.innerHTML = `
        <td>
            <select name="lens_type_id[]" class="select select-bordered w-full lens-type" required>
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¹Ø¯Ø³ÛŒ</option>
                {% for lens_type in lens_types %}
                <option value="{{ lens_type.id }}" data-price="{{ lens_type.default_price }}">{{ lens_type.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select name="lens_cut_type_id[]" class="select select-bordered w-full lens-cut-type" required>
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ØªØ±Ø§Ø´</option>
                {% for cut_type in lens_cut_types %}
                <option value="{{ cut_type.id }}" data-price="{{ cut_type.default_price }}">{{ cut_type.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="lens_quantity[]" value="1" min="1" class="input input-bordered w-full lens-quantity" required>
        </td>
        <td>
            <input type="number" name="lens_unit_price[]" class="input input-bordered w-full lens-unit-price" placeholder="Ù‚ÛŒÙ…Øª ÙÛŒ (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)" title="Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ† Ù‚ÛŒÙ…Øª Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯">
        </td>
        <td>
            <input type="number" name="lens_price[]" class="input input-bordered w-full lens-price bg-base-200" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-error btn-sm" onclick="removeRow(this)">
                <span>ğŸ—‘ï¸</span>
            </button>
        </td>
    `;

    container.appendChild(newRow);
    setupRowEvents(newRow);
    updateTotals();
}

// ØªØ§Ø¨Ø¹ Ø­Ø°Ù Ø±Ø¯ÛŒÙ
function removeRow(button) {
    const row = button.closest('tr');
    const rowCount = document.querySelectorAll('.lens-row').length;

    if (rowCount > 1) {
        row.remove();
        updateTotals();
    } else {
        alert('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¹Ø¯Ø³ÛŒ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø³ÙØ§Ø±Ø´ Ø¨Ø§Ø´Ø¯');
    }
}

// ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ø±Ø¯ÛŒÙ
function calculateRowPrice(row) {
    const lensType = row.querySelector('.lens-type');
    const cutType = row.querySelector('.lens-cut-type');
    const quantity = row.querySelector('.lens-quantity');
    const unitPrice = row.querySelector('.lens-unit-price');
    const totalPrice = row.querySelector('.lens-price');

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª ÙÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± (ÙÙ‚Ø· Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯)
    if (lensType.value && cutType.value && !unitPrice.value) {
        const lensPrice = parseFloat(lensType.options[lensType.selectedIndex].dataset.price || 0);
        const cutPrice = parseFloat(cutType.options[cutType.selectedIndex].dataset.price || 0);
        unitPrice.value = lensPrice + cutPrice;

        // highlight Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Ø¨Ø±Ø§ÛŒ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù† Ú©Ù‡ Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ø§Ø³Øª
        unitPrice.style.backgroundColor = '#e0f2fe';
        setTimeout(() => {
            unitPrice.style.backgroundColor = '';
        }, 2000);
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ú©Ù„
    const qty = parseInt(quantity.value || 1);
    const unit = parseFloat(unitPrice.value || 0);
    totalPrice.value = qty * unit;

    updateTotals();
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø¬Ù…ÙˆØ¹
function updateTotals() {
    let totalAmount = 0;
    let totalQuantity = 0;

    document.querySelectorAll('.lens-row').forEach(row => {
        const price = parseFloat(row.querySelector('.lens-price').value || 0);
        const quantity = parseInt(row.querySelector('.lens-quantity').value || 0);

        totalAmount += price;
        totalQuantity += quantity;
    });

    document.getElementById('total_amount').value = totalAmount;
    document.getElementById('total-amount-display').textContent = totalAmount.toLocaleString();
    document.getElementById('total-quantity-display').textContent = totalQuantity;

    calculateRemaining();
}

// ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡
function calculateRemaining() {
    const total = parseFloat(document.getElementById('total_amount').value || 0);
    const payment = parseFloat(document.getElementById('payment').value || 0);
    const remaining = total - payment;

    const remainingSpan = document.getElementById('remaining-amount');
    remainingSpan.textContent = remaining.toLocaleString();

    if (remaining <= 0) {
        remainingSpan.className = 'text-success font-bold';
    } else if (payment > 0) {
        remainingSpan.className = 'text-warning font-bold';
    } else {
        remainingSpan.className = 'text-error font-bold';
    }
}

// ØªØ§Ø¨Ø¹ ØªÙ†Ø¸ÛŒÙ… event Ù‡Ø§ÛŒ Ø±Ø¯ÛŒÙ
function setupRowEvents(row) {
    const lensType = row.querySelector('.lens-type');
    const cutType = row.querySelector('.lens-cut-type');
    const quantity = row.querySelector('.lens-quantity');
    const unitPrice = row.querySelector('.lens-unit-price');

    [lensType, cutType, quantity, unitPrice].forEach(element => {
        if (element) {
            element.addEventListener('change', () => calculateRowPrice(row));
            element.addEventListener('input', () => calculateRowPrice(row));
        }
    });
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ
function updateCustomerInfo() {
    const customerSelect = document.getElementById('customer-select');
    const customerInfo = document.getElementById('customer-info');

    if (customerSelect && customerInfo) {
        const selectedOption = customerSelect.options[customerSelect.selectedIndex];
        if (selectedOption.value) {
            const phone = selectedOption.dataset.phone;
            customerInfo.textContent = phone ? `ØªÙ„ÙÙ†: ${phone}` : 'Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†';
        } else {
            customerInfo.textContent = '';
        }
    }
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
document.addEventListener('DOMContentLoaded', function() {
    // ØªÙ†Ø¸ÛŒÙ… event Ù‡Ø§ÛŒ Ø±Ø¯ÛŒÙ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    document.querySelectorAll('.lens-row').forEach(row => {
        setupRowEvents(row);
    });

    // event listener Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ
    const customerSelect = document.getElementById('customer-select');
    if (customerSelect) {
        customerSelect.addEventListener('change', updateCustomerInfo);
    }

    // event listener Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª
    const paymentInput = document.getElementById('payment');
    if (paymentInput) {
        paymentInput.addEventListener('input', calculateRemaining);
    }

    updateCustomerInfo();
    updateTotals();
});
</script>
{% endblock %}